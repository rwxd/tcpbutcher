---
on:
  push:
    branches:
      - main

jobs:
  ci-build:
    strategy:
      matrix:
        go-version:
          - 1.18.2
        os:
          - ubuntu-latest
          - ubuntu-20.04
          # - macos-latest
          # - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: install required packages
        run: sudo apt install -y libpcap-dev

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - run: git fetch --prune --unshallow

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Install Go ${{ matrix.go-version }}
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Go version
        run: go version

      - name: Test
        run: go test ./... -v

      - name: Build
        run: go build

  semantic-release:
    needs:
      - ci-build
    uses: rwxd/gh-templates/.github/workflows/common-semantic-release.yml@main
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  goreleaser:
    needs:
      - semantic-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: install required packages
        run: sudo apt install -y libpcap-dev

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
